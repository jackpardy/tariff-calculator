<!-- templates/calculator.html -->
{{define "content"}}
<div class="container">
    <!-- Skill Calculator -->
    <div class="box">
        <h3 class="title is-4">Skill Calculator</h3>
        <form id="main-form" class="columns is-multiline is-align-items-flex-end">
            <div class="column is-8">
                <div class="columns is-mobile is-vcentered mb-2">
                    <div class="column is-9">
                        <label class="label">Common Skills</label>
                    </div>
                    <div class="column is-3 has-text-right">
                        <div class="select is-small">
                            <select id="skill-sort" class="is-pulled-right" onchange="loadCommonSkillList(this.value)">
                                <option value="tariff">Sort by Tariff</option>
                                <option value="name">Sort by Name</option>
                            </select>
                        </div>
                    </div>
                </div>


                <div class="field">
                    <div class="select is-fullwidth">
                        <select id="common-skills" onchange="loadCommonSkill(this.value)">
                            <option value="">Select common skill...</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>

            </div>
            <div class="column is-4">
                <input type="hidden" id="skill-name" name="name">
                <input type="hidden" id="base-skill-name">
                <div class="field">
                    <label class="label">Skill Name</label>
                    <div class="control">
                        <input class="input" type="text" id="skill-name-display"
                               readonly
                               placeholder="Custom Skill">
                    </div>
                </div>
            </div>
            <!-- Row 1: Rotation and Twist -->
            <div class="column is-2">
                <div class="field">
                    <label class="label">Rotation in 1/4s </label>
                    <div class="control">
                        <input class="input" type="number" id="rotation" name="rotation"
                               min="-16" max="16" step="1" value="4"
                               oninput="validateRotation(this)">
                    </div>
                </div>
            </div>

            <div class="column is-4" id="twist-distribution-container">
                <div class="field">
                    <label class="label">Twist in 1/2s per somersault</label>
                    <div class="columns is-mobile is-multiline" id="twist-fields">
                        <div class="column is-3">
                            <div class="field">
                                <input class="input twist-rotation" type="number"
                                       min="0" value="0" data-rotation="1">
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <input class="input twist-rotation" type="number"
                                       min="0" value="0" data-rotation="2">
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <input class="input twist-rotation" type="number"
                                       min="0" value="0" data-rotation="3">
                            </div>
                        </div>
                        <div class="column is-3">
                            <div class="field">
                                <input class="input twist-rotation" type="number"
                                       min="0" value="0" data-rotation="4">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Takeoff and Shape (now horizontal) -->
            <div class="column is-2">
                <div class="field">
                    <label class="label">Takeoff</label>
                    <div class="select is-fullwidth">
                        <select name="takeoff" id="takeoff_position">
                            <option value="feet">Feet</option>
                            <option value="front">Front</option>
                            <option value="back">Back</option>
                            <option value="seat">Seat</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="column is-2">
                <div class="field">
                    <label class="label">Shape</label>
                    <div class="select is-fullwidth">
                        <select name="shape" id="shape">
                            <option value="straight">Straight</option>
                            <option value="tuck">Tuck</option>
                            <option value="pike">Pike</option>
                            <option value="straddle">Straddle</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="column is-2">
                <div class="field">
                    <label class="checkbox mt-2">
                        <input type="checkbox" name="seat_landing" id="seat_landing">
                        Seat Landing
                    </label>
                    <label class="checkbox mt-2">
                        <input type="checkbox" id="backward-flag" name="backward">
                        Back S/S
                    </label>
                </div>
            </div>

            <!-- Button -->
            <div class="column is-2">
                <div class="field">
                    <label class="label">&nbsp;</label>
                    <button type="button" id="submit-btn"
                            class="button is-primary is-fullwidth"
                            onclick="calculateAndAdd()">
                        Add to Routine
                    </button>
                </div>
            </div>
            <div class="column is-2">
                <div class="field">
                    <label class="label">&nbsp;</label>
                    <button type="button" class="button is-info is-fullwidth"
                            onclick="evaluateSkill()">
                        Evaluate Skill
                    </button>
                </div>
            </div>
            <div class="column is-2" id="cancel-btn-wrapper">
                <div class="field">
                    <label class="label">&nbsp;</label>
                    <button type="button" id="cancel-btn"
                            class="button is-danger is-fullwidth is-hidden"
                            onclick="cancelEdit()">
                        Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="box" id="evaluation-preview" style="display: none;">
        <h4 class="title is-6 mb-3">Skill Evaluation</h4>
        <div class="content">
            <div class="columns is-vcentered">
                <div class="column">
                    <p><strong>Rotation:</strong> ${Math.abs(data.rotation)} ${data.backward ? 'B' : 'F'}</p>
                    <p><strong>Twists:</strong> ${data.twist_distribution.join(' | ')}</p>
                </div>
                <div class="column">
                    <p><strong>Takeoff:</strong> ${data.takeoff_position}</p>
                    <p><strong>Landing:</strong> ${data.landing_position}</p>
                </div>
                <div class="column">
                    <p><strong>Shape:</strong> ${data.shape}</p>
                    <p><strong class="has-text-primary">Tariff: ${data.tariff.toFixed(2)}</strong></p>
                </div>
            </div>
        </div>
        <div class="buttons mt-3">
            <button class="button is-info" onclick="addEvaluatedSkill()">Add to Routine</button>
            <button class="button" onclick="document.getElementById('evaluation-preview').style.display='none'">Close
            </button>
        </div>
    </div>

    <!-- Routine Display -->
    <div class="box">
        <h3 class="title is-4">Routine Builder</h3>
        <div id="routine-skills" class="routine-skills">
            <!-- Skills will be added here -->
        </div>
        <div id="routine-results" class="mt-4">
            <div id="routine-total"></div>
        </div>
    </div>
</div>

<script>
    let dragActivationTimer = null;
    const DRAG_ACTIVATION_DELAY = 300; // 300ms delay
    const TOUCH_MOVE_THRESHOLD = 5; // 5px movement cancels drag

    let commonSkills = {};

    async function loadCommonSkillList(sortBy = 'tariff') {
        try {
            const response = await fetch('/api/common-skills');
            const commonSkillsMap = await response.json();
            localStorage.setItem('commonSkills', JSON.stringify(commonSkillsMap));

            // Convert to sorted array
            const skillArray = Object.entries(commonSkillsMap).map(([key, skill]) => ({
                key,
                name: skill.name,
                tariff: skill.tariff || 0,
                raw: skill
            }));

            // Sorting logic
            skillArray.sort((a, b) => {
                if (sortBy === 'tariff') {
                    return a.tariff - b.tariff || a.name.localeCompare(b.name);
                }
                return a.name.localeCompare(b.name);
            });

            // Update dropdown
            const select = document.getElementById('common-skills');
            select.innerHTML = '<option value="">Select common skill...</option>';
            skillArray.forEach(({key, name, tariff}) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${name} (${tariff.toFixed(1)})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Failed to load skills:", error);
            showErrorToast("Couldn't load skill list");
        }
    }


    // Call this on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadCommonSkillList();
        // ... other initialization
    });

    async function loadCommonSkill(skillKey) {
        try {
            if (!skillKey) return;

            // Fetch skill using the original key-based endpoint
            const response = await fetch(`/api/common-skill/${encodeURIComponent(skillKey)}`);
            if (!response.ok) throw new Error("Skill not found");
            const skill = await response.json();

            // Update form fields using MAP CASE
            document.getElementById('rotation').value = Math.abs(skill.rotation || 0);
            document.getElementById('backward-flag').checked = skill.backward || false;
            document.getElementById('takeoff_position').value = skill.takeoff_position.toLowerCase();
            document.getElementById('shape').value = skill.shape.toLowerCase();
            document.getElementById('seat_landing').checked = skill.seat_landing || false;

            // Set twist distribution
            (skill.twist_distribution || []).forEach((twist, i) => {
                const input = document.querySelector(`.twist-rotation[data-rotation="${i + 1}"]`);
                if (input) input.value = twist || 0;
            });
            handleRotationChange()
            document.getElementById('skill-name-display').value = skill.name;
            document.getElementById('base-skill-name').value = skill.name;
            document.getElementById('skill-name').value = skill.name;

        } catch (error) {
            console.error("Failed to load skill:", error);
            showErrorToast("Couldn't load skill: " + error.message);
            document.getElementById('common-skills').value = "";
        }
    }

    const clearNameOnChange = () => {
        if (document.getElementById('skill-name-display').value ===
            document.getElementById('base-skill-name').value) {
            document.getElementById('skill-name-display').value = "Custom Skill";
            document.getElementById('base-skill-name').value = "";
            document.getElementById('skill-name').value = "";
        }
    };

    document.querySelectorAll('#main-form input, #main-form select')
        .forEach(element => {
            element.addEventListener('change', clearNameOnChange);
        });

    function validateRotation(input) {
        // Enforce maximum value
        if (input.value > 16) {
            input.value = 16;
            showErrorToast("Maximum rotation is 16 (4 full rotations)");
        }
        if (input.value < 0) {
            const backwardCheckbox = document.getElementById('backward-flag');
            backwardCheckbox.checked = true;
            input.value = Math.abs(input.value); // Convert to positive
        }
        updateTwistFields(input.value);
    }

    function showErrorToast(message) {
        const toast = document.createElement('div');
        toast.className = 'notification is-danger is-light';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function cancelEdit() {
        resetForm();
        document.getElementById('cancel-btn').classList.add('is-hidden');
    }

    async function removeSkill(button) {
        const skillDiv = button.closest('.routine-skill');
        if (skillDiv && skillDiv.parentNode) {
            skillDiv.parentNode.removeChild(skillDiv);
            await updateRoutineTotal();
            await validateRoutineSequence();
        }
    }

    let editingIndex = null;

    function editSkill(button) {
        const skillDiv = button.closest('.routine-skill');
        const skill = JSON.parse(skillDiv.dataset.skill);

        // Populate form with proper element IDs
        document.getElementById('skill-name-display').value = skill.name;
        document.getElementById('base-skill-name').value = skill.name;
        document.getElementById('skill-name').value = skill.name || "";
        document.getElementById('rotation').value = Math.abs(skill.rotation);
        document.getElementById('takeoff_position').value = skill.takeoff_position.toLowerCase();
        document.getElementById('shape').value = skill.shape.toLowerCase();
        document.getElementById('backward-flag').checked = skill.backward;
        document.getElementById('seat_landing').checked = skill.seat_landing;
        document.getElementById('cancel-btn').classList.remove('is-hidden');
        if (skill.twist_distribution) {
            skill.twist_distribution.forEach((twist, i) => {
                const input = document.querySelector(`.twist-rotation[data-rotation="${i + 1}"]`);
                if (input) {
                    input.value = twist;
                    savedTwists[i] = twist;
                }
            });
        }
        handleRotationChange()
        // Update button behavior
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.textContent = "Update Skill";
        submitBtn.onclick = () => updateSkill(skillDiv);
    }

    function resetForm() {
        const form = document.getElementById('main-form');
        form.reset();
        handleRotationChange()
        document.getElementById('submit-btn').textContent = "Add Skill";
        document.getElementById('cancel-btn').classList.add('is-hidden');
        document.getElementById('submit-btn').onclick = calculateAndAdd;
    }

    async function updateSkill(skillDiv) {
        const numRotations = calculatePhases(Math.abs(parseInt(document.getElementById('rotation').value)));
        const twistInputs = [...document.querySelectorAll('.twist-rotation')];
        const twistDistribution = twistInputs
            .slice(0, numRotations) // Only take needed rotations
            .map(input => parseInt(input.value) || 0);
        const form = document.getElementById('main-form');
        const index = Array.from(document.getElementById('routine-skills').children).indexOf(skillDiv);

        const updatedSkill = {
            name: document.getElementById('skill-name-display').value,
            rotation: parseInt(form.rotation.value) || 0,
            twist_distribution: twistDistribution,
            takeoff_position: form.takeoff_position.value,
            shape: form.shape.value,
            backward: document.getElementById('backward-flag').checked,
            seat_landing: form.seat_landing.checked
        };

        try {
            const response = await fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(updatedSkill)
            });
            const data = await response.json();
            skillDiv.replaceWith(createSkillElement(data));
            resetForm();
            await updateRoutineTotal(); // Added await
            await validateRoutineSequence(); // Added await
        } catch (error) {
            console.error('Update failed:', error);
            showErrorToast("Failed to update skill");
        }
    }

    async function calculateAndAdd() {
        const form = document.getElementById('main-form');
        const numRotations = calculatePhases(Math.abs(parseInt(document.getElementById('rotation').value)));
        const twistInputs = [...document.querySelectorAll('.twist-rotation')];

        const twistDistribution = twistInputs
            .slice(0, numRotations) // Only take needed rotations
            .map(input => parseInt(input.value) || 0);
        try {
            // Use form.elements instead of querySelector
            const formData = {
                name: document.getElementById('skill-name-display').value,
                rotation: Math.abs(parseInt(form.elements.rotation.value)) || 0,
                twist_distribution: twistDistribution,
                takeoff_position: form.elements.takeoff.value, // Changed from takeoff_position to takeoff
                shape: form.elements.shape.value,
                backward: document.getElementById('backward-flag').checked,
                seat_landing: form.elements.seat_landing.checked
            };

            const response = await fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });

            if (!response.ok) throw new Error('Calculation failed');
            const data = await response.json();

            await addToRoutine(data, false, insertIndex);// Changed to await
            form.reset();

        } catch (error) {
            console.error('Error:', error);
            showErrorToast("Failed to calculate skill: " + error.message);
        }
    }

    let draggedSkill = null;

    async function addToRoutine(skill, isUpdate = false, index = null) {
        const routineSkills = document.getElementById('routine-skills');
        const skills = Array.from(routineSkills.children);

        const newElement = createSkillElement(skill);
        if (typeof index === 'number' && index >= 0 && index <= skills.length) {
            if (index === skills.length) {
                routineSkills.appendChild(newElement);
            } else {
                routineSkills.insertBefore(newElement, routineSkills.children[index]);
            }
        } else {
            routineSkills.appendChild(newElement);
        }

        await updateRoutineTotal();
        await validateRoutineSequence();
        insertIndex = null; // Reset insertion point after adding
    }

    function createSkillElement(skill, index) {
        const skillDiv = document.createElement('div');
        skillDiv.className = 'routine-skill box mb-2';
        skillDiv.draggable = true;
        skillDiv.dataset.skill = JSON.stringify(skill);
        const skillName = skill.name || getCommonSkillName(skill) || 'Custom Skill';
        skillDiv.innerHTML = `
        <div class="columns is-mobile is-vcentered is-flex-grow-1">
    <!-- Skill Details -->
    <div class="column is-4-mobile is-3-tablet">
        <p><strong>${skillName}</strong></p>
        <p>${Math.abs(skill.rotation)} ${skill.backward ? 'B' : 'F'}</p>
    </div>

    <div class="column is-2-mobile is-2-tablet">
        <p>${skill.twist_distribution.join(' | ')}</p>
    </div>

    <div class="column is-3-mobile is-2-tablet">
        <p>${skill.takeoff_position} → ${skill.landing_position}</p>
    </div>

    <div class="column is-2-mobile is-2-tablet">
        <p>${skill.shape}</p>
    </div>

    <div class="column is-2-mobile is-1-tablet">
        <p class="has-text-primary">${skill.tariff.toFixed(2)}</p>
    </div>

    <!-- Controls Column - Updated Structure -->
    <div class="column is-4-mobile is-2-tablet">
        <div class="buttons are-small is-flex is-justify-content-flex-end">
            <div class="is-flex is-align-items-center" style="gap: 0.5rem">
                <!-- Vertical Arrows for Tablet+ -->
                <div class="is-hidden-mobile">
                    <button class="button" onclick="moveSkillUp(this)">↑</button>
                    <button class="button" onclick="moveSkillDown(this)">↓</button>
                </div>

                <!-- Horizontal Arrows for Mobile -->
                <div class="is-flex is-hidden-tablet" style="gap: 0.25rem">
                    <button class="button" onclick="moveSkillUp(this)">↑</button>
                    <button class="button" onclick="moveSkillDown(this)">↓</button>
                </div>

                <button class="button is-info is-small"
                        onclick="editSkill(this)">Edit</button>
                <button class="delete is-danger"
                        onclick="removeSkill(this)"></button>
            </div>
        </div>
    </div>
</div>
        <div class="columns is-mobile">
                <div class="column is-12">
                    <p class="transition-status has-text-danger is-size-7 mt-1"></p>
                </div>
            </div>
        </div>
    `;

        // Drag events
        skillDiv.addEventListener('dragstart', () => {
            draggedSkill = skillDiv;
            setTimeout(() => skillDiv.classList.add('is-dragging'), 0);
        });

        skillDiv.addEventListener('dragend', async () => {
            draggedSkill = null;
            skillDiv.classList.remove('is-dragging');
            await validateRoutineSequence();
            await updateRoutineTotal();
        });

        return skillDiv;
    }

    function getCommonSkillName(skillData) {
        const commonSkills = JSON.parse(localStorage.getItem('commonSkills')) || {};
        return Object.values(commonSkills).find(skill =>
            skill.rotation === skillData.rotation &&
            skill.backward === skillData.backward &&
            skill.takeoff_position === skillData.takeoff_position &&
            skill.shape === skillData.shape &&
            JSON.stringify(skill.twist_distribution) === JSON.stringify(skillData.twist_distribution)
        )?.name;
    }

    // Drag-and-drop handlers
    document.getElementById('routine-skills').addEventListener('dragover', e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(e.clientY);
        const container = document.getElementById('routine-skills');

        if (!afterElement) {
            container.appendChild(draggedSkill);
        } else {
            container.insertBefore(draggedSkill, afterElement);
        }
    });

    function getDragAfterElement(y) {
        const skills = [...document.querySelectorAll('.routine-skill:not(.is-dragging)')];

        return skills.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            // Check if we're at the end of the list
            if (offset < 0 && offset > closest.offset) {
                return {offset, element: child};
            } else if (offset > 0 && child === skills[skills.length - 1]) {
                return {offset: Infinity, element: null}; // Special case for end
            }
            return closest;
        }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    // Routine validation
    async function validateRoutineSequence() {
        const skills = [...document.querySelectorAll('.routine-skill')].map(el =>
            JSON.parse(el.dataset.skill)
        );

        try {
            const validation = await validateRoutine(skills);

            // Clear previous status
            document.querySelectorAll('.routine-skill').forEach(el => {
                el.style.borderLeft = '4px solid #485fc7';
                el.querySelector('.transition-status').textContent = '';
            });

            // Highlight invalid transitions
            validation.messages.forEach((message, index) => {
                if (!message) return;

                const skillEl = document.querySelectorAll('.routine-skill')[index];
                if (!skillEl) return;

                // Set border color based on priority
                if (validation.invalidLandings.includes(index)) {
                    skillEl.style.borderLeft = '4px solid #ff69b4'; // Pink
                } else if (validation.invalidTransitions.includes(index)) {
                    skillEl.style.borderLeft = '4px solid #ff3860'; // Red
                } else if (validation.duplicates.includes(index)) {
                    skillEl.style.borderLeft = '4px solid #ffdd57'; // Yellow
                }
                skillEl.querySelector('.transition-status').textContent = message;
            });
        } catch (error) {
            console.error("Validation failed:", error);
            showErrorToast("Couldn't validate routine");
        }
    }


    async function updateRoutineTotal() {
        const skills = [...document.querySelectorAll('.routine-skill')].map(el =>
            JSON.parse(el.dataset.skill)
        );

        try {
            const validation = await validateRoutine(skills);
            const totalElement = document.getElementById('routine-total');
            const rawTotal = validation.duplicates.length > 0 ? '<p class="subtitle">Raw Total (with duplicates):' + validation.rawTariff.toFixed(2) + '</p>' : '';
            totalElement.innerHTML = `
            <div class="card">
    <div class="card-content">
        <p class="title">Total Tariff: ${validation.totalTariff.toFixed(2)}</p>
        <p class="subtitle">${skills.length} of 10 skills</p>
        ${rawTotal ? rawTotal : ''}
        <div class="validation-messages mt-3">
            ${validation.duplicates.length > 0 ?
                '<p class="has-text-warning mb-2">⚠️ Duplicate skills only count once!</p>' : ''}
            ${validation.invalidTransitions.length > 0 ?
                '<p class="has-text-danger">❌ Invalid transitions detected</p>' : ''}
            ${validation.tenthSkillWarning ?
                '<p class="has-text-danger">⚠️ The final skill must land on feet!</p>' : ''}
        </div>
    </div>
</div>
        `;
        } catch (error) {
            console.error("Failed to update total:", error);
            showErrorToast("Couldn't calculate routine total");
        }
    }

    async function validateRoutine(skills) {
        const response = await fetch('/validate-routine', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(skills)
        });
        return response.json();
    }

    let currentEvaluatedSkill = null;

    function evaluateSkill() {
        const form = document.getElementById('main-form');
        const twistInputs = [...document.querySelectorAll('.twist-rotation:not(:disabled)')];
        const twistDistribution = twistInputs.map(input => parseInt(input.value) || 0);
        const formData = {
            rotation: Math.abs(parseInt(form.rotation.value)) || 0,
            twist_distribution: twistDistribution,
            takeoff_position: form.takeoff.value,
            shape: form.shape.value,
            backward: document.getElementById('backward-flag').checked,
            seat_landing: form.seat_landing.checked
        };

        fetch('/api/calculate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                currentEvaluatedSkill = data
                currentEvaluatedSkill.name = document.getElementById('skill-name-display').value;
                document.getElementById('evaluation-preview').style.display = 'block';
                document.getElementById('evaluation-preview').innerHTML = `
            <h4 class="title is-6 mb-3">Skill Evaluation - ${currentEvaluatedSkill.name}</h4>
            <div class="content">
                <div class="columns is-vcentered">
                    <div class="column">
                        <p><strong>Rotation:</strong> ${Math.abs(data.rotation)} ${data.backward ? 'B' : 'F'}</p>
                        <p><strong>Twists:</strong> ${data.twist_distribution.join(' | ')}</p>
                    </div>
                    <div class="column">
                        <p><strong>Takeoff:</strong> ${data.takeoff_position}</p>
                        <p><strong>Landing:</strong> ${data.landing_position}</p>
                    </div>
                    <div class="column">
                        <p><strong>Shape:</strong> ${data.shape}</p>
                        <p><strong>Tariff:</strong> ${data.tariff.toFixed(2)}</p>
                    </div>
                </div>
            </div>
            <div class="buttons mt-3">
                <button class="button is-info" onclick="addEvaluatedSkill()">Add to Routine</button>
                <button class="button" onclick="document.getElementById('evaluation-preview').style.display='none'">Close</button>
            </div>
        `;
                document.getElementById('evaluation-preview').dataset.skill = JSON.stringify(data);
            });
    }

    // Function to add evaluated skill
    function addEvaluatedSkill() {
        if (!currentEvaluatedSkill) return;

        // Use the existing addToRoutine function in "add new" mode
        addToRoutine(currentEvaluatedSkill, false, insertIndex);
        document.getElementById('evaluation-preview').style.display = 'none';
        resetForm();
    }

    let savedTwists = [0, 0, 0, 0];

    function updateTwistFields(rotation) {
        const phases = calculatePhases(rotation);
        const inputs = document.querySelectorAll('.twist-rotation');

        // Save current values
        inputs.forEach((input, i) => {
            savedTwists[i] = parseInt(input.value) || 0;
        });

        // Update field states
        inputs.forEach((input, i) => {
            const rotationNum = i + 1;
            if (rotationNum <= phases) {
                input.disabled = false;
                input.value = savedTwists[i];
                input.parentNode.parentNode.style.opacity = '1';
            } else {
                input.disabled = true;
                input.parentNode.parentNode.style.opacity = '0.5';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateTwistFields(document.getElementById('rotation').value);
    });
    document.getElementById('rotation').addEventListener('input', handleRotationChange);

    function handleRotationChange() {
        const rotationInput = document.getElementById('rotation');
        const rotationValue = Math.abs(parseInt(rotationInput.value) || 0);
        updateTwistFields(rotationValue);
    }

    function calculatePhases(rotation) {
        rotation = Math.abs(rotation);
        if (rotation <= 6) return 1;
        if (rotation <= 10) return 2;
        if (rotation <= 14) return 3;
        return 4;
    }

    let insertIndex = null;

    function moveSkillUp(button) {
        const skillDiv = button.closest('.routine-skill');
        const prev = skillDiv.previousElementSibling;
        if (prev) {
            skillDiv.parentNode.insertBefore(skillDiv, prev);
            updateRoutineTotal();
            validateRoutineSequence();
        }
    }

    function moveSkillDown(button) {
        const skillDiv = button.closest('.routine-skill');
        const next = skillDiv.nextElementSibling;
        if (next) {
            skillDiv.parentNode.insertBefore(skillDiv, next.nextSibling);
            updateRoutineTotal();
            validateRoutineSequence();
        }
    }

    let touchStartY = null;
    let draggedElement = null;
    let originalIndex = null;

    document.addEventListener('touchstart', e => {
        const touch = e.touches[0];
        const target = touch.target;

        if (target.closest('button, .delete')) return;

        touchStartY = touch.clientY;
        const startX = touch.clientX;
        const startY = touch.clientY;
        draggedElement = target.closest('.routine-skill');

        if (!draggedElement) return;

        // Set activation timer
        dragActivationTimer = setTimeout(() => {
            originalIndex = Array.from(draggedElement.parentNode.children)
                .indexOf(draggedElement);
            draggedElement.style.transition = 'none';
            draggedElement.style.opacity = '0.8';
            draggedElement.classList.add('dragging');
        }, DRAG_ACTIVATION_DELAY);

        // Track initial position
        const checkMovement = (moveEvent) => {
            const currentX = moveEvent.touches[0].clientX;
            const currentY = moveEvent.touches[0].clientY;

            // Cancel drag if movement exceeds threshold during activation delay
            if (Math.abs(currentX - startX) > TOUCH_MOVE_THRESHOLD ||
                Math.abs(currentY - startY) > TOUCH_MOVE_THRESHOLD) {
                clearTimeout(dragActivationTimer);
                document.removeEventListener('touchmove', checkMovement);
            }
        };

        document.addEventListener('touchmove', checkMovement);
    }, { passive: true });

    document.addEventListener('touchmove', e => {
        if (!draggedElement || !draggedElement.classList.contains('dragging')) return;
        e.preventDefault();

        const touch = e.touches[0];
        const y = touch.clientY;
        const container = document.getElementById('routine-skills');
        const children = Array.from(container.children);

        // Find new position
        const afterElement = children.reduce((closest, child) => {
            if (child === draggedElement) return closest;
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height/2;

            if (offset < 0 && offset > closest.offset) {
                return { offset, element: child };
            }
            return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;

        if (afterElement) {
            container.insertBefore(draggedElement, afterElement);
        } else {
            container.appendChild(draggedElement);
        }

    }, { passive: false });

    document.addEventListener('touchend', () => {
        clearTimeout(dragActivationTimer);
        if (draggedElement && draggedElement.classList.contains('dragging')) {

            draggedElement.style.transition = '';
            draggedElement.style.opacity = '';

            // Only trigger validation if position changed
            const newIndex = Array.from(draggedElement.parentNode.children)
                .indexOf(draggedElement);
            if (newIndex !== originalIndex) {
                validateRoutineSequence();
                updateRoutineTotal();
            }

            touchStartY = null;
            draggedElement = null;
            originalIndex = null;
        }
        draggedElement = null;
        touchStartY = null;
        originalIndex = null;
    });

    let xDown = null;
    let yDown = null;
    let draggedSkillMobile = null;

    function handleTouchStart(evt) {
        xDown = evt.touches[0].clientX;
        yDown = evt.touches[0].clientY;
        draggedSkillMobile = evt.target.closest('.routine-skill');
    }

    function handleTouchMove(evt) {
        if (!draggedSkillMobile) return;

        const xUp = evt.touches[0].clientX;
        const yUp = evt.touches[0].clientY;

        const xDiff = xDown - xUp;
        const yDiff = yDown - yUp;

        if (Math.abs(xDiff) < Math.abs(yDiff)) { // Vertical swipe
            evt.preventDefault();
            const afterElement = getDragAfterElement(yUp);
            const container = document.getElementById('routine-skills');

            if (!afterElement) {
                container.appendChild(draggedSkillMobile);
            } else {
                container.insertBefore(draggedSkillMobile, afterElement);
            }
        }

        xDown = xUp;
        yDown = yUp;
    }
</script>

<style>
    .routine-skills .box {
        margin-bottom: 1rem;
        border-left: 4px solid #485fc7;
    }

    .routine-skill:hover {
        background-color: #f5f5f5;
    }
</style>
{{end}}